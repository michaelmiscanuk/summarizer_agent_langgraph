# Dockerfile for Ollama on Railway (CPU-only)
FROM ollama/ollama:latest

# Set environment variables
ENV OLLAMA_HOST=0.0.0.0:11434
ENV OLLAMA_ORIGINS=*

# Expose the Ollama API port
EXPOSE 11434

# Create a startup script that pulls the model and starts Ollama
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
echo "Starting Ollama server..."\n\
# Start Ollama in the background\n\
ollama serve &\n\
OLLAMA_PID=$!\n\
\n\
# Wait for Ollama to be ready\n\
sleep 10\n\
\n\
# Pull the model if not already present\n\
echo "Checking for qwen2.5-coder:0.5b model..."\n\
if ! ollama list | grep -q "qwen2.5-coder:0.5b"; then\n\
    echo "Pulling qwen2.5-coder:0.5b model..."\n\
    ollama pull qwen2.5-coder:0.5b\n\
else\n\
    echo "Model already present, skipping pull"\n\
fi\n\
\n\
echo "Ollama is ready!"\n\
# Keep the container running\n\
wait $OLLAMA_PID\n\
' > /start.sh && chmod +x /start.sh

# Run the startup script
CMD ["/bin/bash", "/start.sh"]
